<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="ai_production_assistant.AiChat" owl="1">
        <div t-attf-class="o_ai_chat_container h-100 d-flex flex-column {{ state.darkMode ? 'o_ai_chat_dark' : '' }}">

            <!-- Header -->
            <div class="o_ai_chat_header p-3 border-bottom d-flex justify-content-between align-items-center shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="avatar bg-gradient-primary text-white rounded-circle d-flex justify-content-center align-items-center me-3 shadow-sm fs-4 overflow-hidden" style="width: 42px; height: 42px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <img t-att-src="avatarUrl" style="width: 100%; height: 100%; object-fit: cover;"/>
                    </div>
                    <div>
                        <h5 class="m-0 fw-bold">Asistente IA</h5>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge rounded-pill bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                <i class="fa fa-microchip me-1"/>
                                <t t-esc="state.selectedModel"/>
                            </span>
                            <small t-if="state.isThinking" class="text-success animate-pulse">
                                <i class="fa fa-circle small"/> Procesando
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Controles -->
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-link text-decoration-none" t-on-click="toggleDarkMode" title="Cambiar modo">
                        <i t-if="!state.darkMode" class="fa fa-moon-o fa-lg text-dark opacity-50 hover-opacity-100"/>
                        <i t-if="state.darkMode" class="fa fa-sun-o fa-lg text-warning"/>
                    </button>
                    <div class="vr mx-1 opacity-25"></div>
                    <button class="btn btn-sm btn-outline-primary" t-on-click="newChat" title="Nueva conversaci贸n">
                        <i class="fa fa-plus"/>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" t-on-click="toggleSettings" title="Configuraci贸n">
                        <i class="fa fa-cog"/>
                    </button>
                     <button class="btn btn-sm btn-outline-danger" t-on-click="clearHistory" title="Borrar historial">
                        <i class="fa fa-trash"/>
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div t-if="state.showSettings" class="o_ai_chat_settings p-3 border-bottom">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-uppercase opacity-75">Seleccionar Modelo</label>
                    <select class="form-select form-select-sm" t-on-change="onModelChange" id="ai_model_select" name="ai_model_select">
                            <t t-foreach="state.availableModels" t-as="model" t-key="model.id">
                                <option t-att-value="model.name" t-att-selected="model.name === state.selectedModel">
                                    <t t-esc="model.name"/>
                                </option>
                            </t>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-uppercase opacity-75">Sesi贸n Actual</label>
                        <div class="small opacity-75 font-monospace">
                            ID: <t t-esc="state.sessionId || 'N/A'"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="o_ai_chat_messages flex-grow-1 p-4 overflow-auto" style="scroll-behavior: smooth;">
                <t t-foreach="state.messages" t-as="msg" t-key="msg_index">
                    <div t-attf-class="d-flex mb-3 {{ msg.role === 'user' ? 'justify-content-end' : 'justify-content-start' }}">

                        <!-- Avatar Assistant -->
                        <div t-if="msg.role === 'assistant'" class="me-2 mt-auto">
                            <div class="rounded-circle d-flex align-items-center justify-content-center border o_ai_chat_bubble_assistant overflow-hidden" style="width: 32px; height: 32px;">
                                <img t-if="props.avatarUrl" t-att-src="props.avatarUrl" style="width: 100%; height: 100%; object-fit: cover;"/>
                                <span t-else=""></span>
                            </div>
                        </div>

                        <!-- Bubble -->
                        <div t-attf-class="p-3 shadow-sm {{ msg.role === 'user' ? 'bg-primary text-white' : 'o_ai_chat_bubble_assistant' }}"
                             style="max-width: 80%; border-radius: 1.2rem; min-width: 80px;">

                            <!-- Hora -->
                            <div class="d-flex justify-content-between align-items-center mb-1 opacity-50 small" style="font-size: 0.7rem;">
                                <span t-if="msg.role === 'assistant'" class="fw-bold me-2"><t t-esc="msg.expert || 'IA'"/></span>
                                <span><t t-esc="msg.time"/></span>
                                <span t-if="msg.role === 'user'" class="fw-bold ms-2 text-white">T煤</span>
                            </div>

                            <!-- Content -->
                            <div class="content" style="white-space: pre-wrap; word-wrap: break-word;">
                                <t t-esc="msg.text"/>
                            </div>

                            <!-- Action UI -->
                            <div t-if="msg.pendingAction" class="mt-3 p-2 rounded border-top bg-warning-subtle text-dark">
                                <div class="small fw-bold mb-2">
                                    <i class="fa fa-bolt me-1"/> Sugerencia de Acci贸n
                                </div>
                                <div class="small mb-2">
                                    <t t-esc="this._formatActionSummary(msg.pendingAction)"/>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success flex-grow-1 shadow-sm" t-on-click="() => this.confirmAction(msg_index)">
                                        <i class="fa fa-check me-1"/> Ejecutar
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary flex-grow-1" t-on-click="() => this.cancelAction(msg_index)">
                                        Descartar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Avatar User -->
                        <div t-if="msg.role === 'user'" class="ms-2 mt-auto">
                            <div class="rounded-circle bg-300 d-flex align-items-center justify-content-center overflow-hidden" style="width: 32px; height: 32px;">
                                
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Thinking -->
                <div t-if="state.isThinking" class="d-flex justify-content-start mb-3">
                    <div class="me-2 mt-auto"></div>
                    <div class="border p-3 rounded-pill shadow-sm o_ai_chat_bubble_assistant">
                        <span class="typing-dots">
                            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                        </span>
                        <small class="ms-2 opacity-75 fst-italic">Procesando...</small>
                    </div>
                </div>

                <div t-ref="messagesEnd"></div>
            </div>

            <!-- Input Area -->
            <div class="o_ai_chat_footer p-3 border-top">
                <div class="input-group input-group-lg shadow-sm">
                    <input type="text" id="ai_chat_input" name="ai_chat_input"
                           class="form-control border-0"
                           placeholder="Pregunta o pide una acci贸n..."
                           t-model="state.input"
                           t-on-keydown="_onKeydown"/>
                    <button class="btn btn-primary px-4" type="button" t-on-click="sendMessage" t-att-disabled="state.isThinking">
                        <i t-if="!state.isThinking" class="fa fa-paper-plane"/>
                        <i t-if="state.isThinking" class="fa fa-spinner fa-spin"/>
                    </button>
                </div>
            </div>
        </div>
    </t>
</templates>
